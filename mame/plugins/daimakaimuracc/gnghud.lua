exports = {}

local gnghud = exports

-- HUD container extends
local x1 = 2
local x2 = 110
local y1 = 210
local y2 = 223

-- GnG font palettes
-- Light orange palette
local p1 = {
    ["0"] = 0,
    ["1"] = 0xFFEE8800,
    ["2"] = 0xFF880000,
    ["3"] = 0xFFFFAA00
}

-- Dark orange palette
local p2 = {
    ["0"] = 0,
    ["1"] = 0xFFDD6600,
    ["2"] = 0xFF883300,
    ["3"] = 0xFFBB4400
}

-- Purple palette
local p3 = {
    ["0"] = 0,
    ["1"] = 0xFFAA77EE,
    ["2"] = 0xFF000088,
    ["3"] = 0xFFCCAAEE
}

-- Grey palette
local p4 = {
    ["0"] = 0,
    ["1"] = 0xFFDDDDDD,
    ["2"] = 0xFF888888,
    ["3"] = 0xFFBBBBBB
}

local pixelMaps = {
    A = {
        8,
        {"0","0","0","0","1","1","1","2"},
        {"0","0","0","1","2","1","3","2"},
        {"0","0","1","2","0","1","3","2"},
        {"0","0","1","2","0","1","3","2"},
        {"0","1","1","3","3","3","3","2"},
        {"0","3","2","2","2","3","3","2"},
        {"3","2","0","0","0","3","2","0"},
        {"2","0","0","0","0","2","0","0"}
    },
    B = {
        8,
        {"1","1","1","1","1","2","0","0"},
        {"2","1","1","2","2","1","2","0"},
        {"0","1","3","1","1","2","0","0"},
        {"0","1","3","2","2","3","2","0"},
        {"0","3","3","2","0","2","3","2"},
        {"0","3","3","2","0","0","3","2"},
        {"3","2","2","3","3","3","2","0"},
        {"2","0","0","2","2","2","0","0"}
    },
    C = {
        8,
        {"0","0","1","1","1","2","0","0"},
        {"0","1","1","2","2","1","2","0"},
        {"1","3","2","0","0","1","0","0"},
        {"3","3","2"},
        {"3","3","2","0","0","0","3","2"},
        {"2","1","2","0","0","3","2","0"},
        {"0","2","3","3","3","2","0","0"},
        {"0","0","2","2","2","0","0","0"}
    },
    D = {
        8,
        {"1","1","2","1","1","2","0","0"},
        {"2","1","1","2","2","3","2","0"},
        {"0","1","1","2","0","2","3","2"},
        {"0","1","3","2","0","0","3","2"},
        {"0","1","3","2","0","0","3","2"},
        {"0","3","3","2","0","3","2","0"},
        {"3","2","2","3","3","2","0","0"},
        {"2","0","0","2","2"}
    },
    E = {
        8,
        {"1","1","2","1","1","1","2","0"},
        {"2","1","1","2","2","2","1","2"},
        {"0","1","3","2"},
        {"0","1","3","3","3","2"},
        {"0","1","3","2","2"},
        {"0","1","3","2","0","0","3","2"},
        {"1","3","3","3","3","3","2"},
        {"2","2","2","2","2","2"}
    },
    F = {
        8,
        {"1","1","2","1","1","1","2"},
        {"2","1","1","2","2","2","1","2"},
        {"0","1","3","2"},
        {"0","1","3","3","3","2"},
        {"0","3","2","2","2"},
        {"0","3","2"},
        {"3","2"},
        {"2"}
    },
    G = {
        8,
        {"0","0","1","1","1","1","2"},
        {"0","1","1","2","2","2","1","2"},
        {"1","3","2"},
        {"3","3","2","1","1","3","1","2"},
        {"3","3","2","0","2","3","2"},
        {"2","3","2","0","3","3","2"},
        {"0","2","3","3","2","2","3","2"},
        {"0","0","2","2"}
    },
    H = {
        8,
        {"1","1","2","0","0","0","1","2"},
        {"2","1","2","0","0","1","1","2"},
        {"0","1","2","0","0","1","3","2"},
        {"0","1","3","3","3","3","3","2"},
        {"0","3","2","2","2","3","3","1"},
        {"0","3","2","0","0","3","1","2"},
        {"3","2","0","0","0","3","2","0"},
        {"2","0","0","0","0","2"}
    },
    I = {
        4,
        {"1","1","1","2"},
        {"2","1","3","2"},
        {"0","1","3","2"},
        {"0","3","1","2"},
        {"0","3","1","2"},
        {"0","3","1","2"},
        {"0","1","2"},
        {"0","2"}
    },
    J = {
        8,
        {"0","0","0","0","0","0","1","2"},
        {"0","0","0","0","0","1","1","2"},
        {"0","0","0","0","0","1","3","2"},
        {"0","1","2","0","0","1","3","2"},
        {"1","2","0","0","0","3","3","2"},
        {"3","2","0","0","3","3","2","0"},
        {"2","3","3","3","2","2","0","0"},
        {"0","2","2","2"}
    },
    K = {
        8,
        {"1","1","2","0","0","1","2"},
        {"2","1","2","0","3","2","1","2"},
        {"0","1","2","3","2"},
        {"0","1","3","3","2"},
        {"0","3","2","1","3","2"},
        {"0","3","2","2","1","3","1","2"},
        {"3","2","0","0","2","3","2"},
        {"2","0","0","0","0","2"}
    },
    L = {
        8,
        {"1","1","2"},
        {"0","1","1","2"},
        {"0","1","1","2"},
        {"0","3","1","2"},
        {"0","3","2"},
        {"0","3","3","3","2","0","1","2"},
        {"3","2","2","2","3","3","2"},
        {"2","0","0","0","2","2"}
    },
    M = {
        8,
        {"1","1","2","0","0","0","1","2"},
        {"2","1","1","2","0","1","3","2"},
        {"0","1","1","1","1","1","3","2"},
        {"0","3","2","3","2","1","3","2"},
        {"0","3","2","3","2","3","3","2"},
        {"0","3","2","2","0","3","1","2"},
        {"3","2","0","0","0","3","2","0"},
        {"2","0","0","0","0","2"}
    },
    N = {
        8,
        {"1","1","2","0","0","0","1"},
        {"2","1","1","2","0","0","1","2"},
        {"0","1","1","1","2","0","3","2"},
        {"0","1","3","2","3","2","3","2"},
        {"0","3","1","2","2","3","3","2"},
        {"0","3","1","2","0","1","3","2"},
        {"3","1","2","0","0","2","3","2"},
        {"2","2","0","0","0","0","2","2"}
    },
    O = {
        8,
        {"0","0","1","1","1","2"},
        {"0","1","1","2","2","3","2"},
        {"1","3","2","0","0","2","3","2"},
        {"3","3","2","0","0","0","3","2"},
        {"3","3","2","0","0","0","3","2"},
        {"2","3","1","2","0","3","2"},
        {"0","2","3","3","3","2"},
        {"0","0","2","2","2"}
    },
    P = {
        8,
        {"1","1","2","1","1","1","2"},
        {"2","1","1","2","2","2","1","2"},
        {"0","1","1","2","0","0","3","2"},
        {"0","1","3","2","0","0","3","2"},
        {"0","3","3","3","3","3","2"},
        {"0","3","1","2","2","2"},
        {"3","2","2"},
        {"2"}
    },
    Q = {
        8,
        {"0","0","1","1","1","2"},
        {"0","1","1","2","2","3","2"},
        {"1","3","2","0","0","0","3","2"},
        {"3","3","2","0","0","0","3","2"},
        {"3","3","2","3","2","3","2"},
        {"2","3","2","2","3","2","1","2"},
        {"0","2","3","3","2","3","2"},
        {"0","0","2","2","0","2"}
    },
    R = {
        8,
        {"1","1","2","1","1","1","2"},
        {"2","1","1","2","2","2","3","2"},
        {"0","1","3","2","0","0","3","2"},
        {"0","1","3","2","0","3","2"},
        {"0","1","3","3","3","2"},
        {"0","3","1","2","3","2","1","2"},
        {"3","2","0","0","2","3","2"},
        {"2","0","0","0","0","2"}
    },
    S = {
        8,
        {"0","0","1","1","1","1","2"},
        {"0","1","1","2","2","2","1","2"},
        {"0","2","1","3","2"},
        {"0","0","2","1","3","2"},
        {"0","1","2","2","1","3","2"},
        {"3","2","0","0","3","3","2"},
        {"2","3","3","3","3","2"},
        {"0","2","2","2","2"}
    },
    T = {
        8,
        {"0","1","1","1","1","1","1","2"},
        {"1","2","2","2","3","2","2"},
        {"2","3","2","3","2"},
        {"0","0","0","3","2"},
        {"0","0","3","1","2"},
        {"0","0","3","2"},
        {"0","0","3","2"},
        {"0","0","2"}
    },
    U = {
        8,
        {"1","1","2","0","0","0","1"},
        {"2","1","1","2","0","0","1","2"},
        {"0","1","1","2","0","0","3","2"},
        {"1","3","2","0","0","0","3","2"},
        {"1","3","2","0","0","3","2"},
        {"1","3","2","0","0","3","2"},
        {"2","1","3","3","3","2"},
        {"0","2","2","2","2"}
    },
    V = {
        8,
        {"1","1","2","0","0","0","1","2"},
        {"2","1","1","2","0","3","2"},
        {"0","1","1","2","3","2"},
        {"0","1","1","2","3","2"},
        {"0","0","3","3","2"},
        {"0","0","3","1","2"},
        {"0","0","1","2"},
        {"0","0","2"}
    },
    W = {
        8,
        {"0","1","2","0","0","1","2"},
        {"1","2","0","0","0","1","1","2"},
        {"1","2","0","0","0","1","3","2"},
        {"3","2","1","2","0","1","3","2"},
        {"3","2","3","2","0","3","3","2"},
        {"3","2","3","2","1","3","2"},
        {"2","3","2","3","3","2"},
        {"0","2","0","0","2"}
    },
    X = {
        8,
        {"1","1","2","0","0","1","2"},
        {"2","2","1","2","1","3","1","2"},
        {"0","0","2","1","3","2","2"},
        {"0","0","1","3","2"},
        {"0","1","3","3","2"},
        {"1","3","2","2","3","2","1"},
        {"3","2","0","0","2","3","2"},
        {"2","0","0","0","0","2"}
    },
    Y = {
        8,
        {"1","1","2","0","1","1","1","2"},
        {"2","1","2","0","2","3","1","2"},
        {"0","2","3","2","3","1","2"},
        {"0","0","2","3","3","2"},
        {"0","0","0","3","2"},
        {"0","0","3","2"},
        {"0","0","3","2"},
        {"0","0","2"}
    },
    Z = {
        8,
        {"0","1","1","1","1","1","1","2"},
        {"1","2","2","2","1","1","2"},
        {"2","0","0","1","3","2"},
        {"0","0","2","3","1"},
        {"0","1","3","2"},
        {"1","3","1","3","2","0","1","2"},
        {"3","2","2","2","3","3","2"},
        {"2","0","0","0","2","2"}
    },
    ["0"] = {
        8,
        {"0","0","0","1","1","1","2"},
        {"0","1","1","2","2","1","1","2"},
        {"1","1","2","0","0","1","3","2"},
        {"3","2","0","0","0","1","3","2"},
        {"3","2","0","0","0","1","3","2"},
        {"2","3","2","0","1","3","2"},
        {"0","2","3","3","3","2"},
        {"0","0","2","2","2"}
    },
    ["1"] = {
        5,
        {"0","0","0","1","2"},
        {"1","1","3","1","2"},
        {"2","2","3","2"},
        {"0","1","3","2"},
        {"0","3","1","2"},
        {"0","3","1","2"},
        {"0","3","2"},
        {"0","2"}
    },
    ["2"] = {
        8,
        {"0","0","1","1","1","1","2"},
        {"0","1","2","2","2","1","1","2"},
        {"0","2","0","0","0","3","1","2"},
        {"0","0","0","0","3","1","2"},
        {"0","0","3","3","2","2"},
        {"0","3","1","2","0","0","1","2"},
        {"3","3","3","3","3","1","2"},
        {"2","2","2","2","2","2"}
    },
    ["3"] = {
        7,
        {"1","1","1","1","1","2"},
        {"2","2","2","1","2"},
        {"0","0","1","3","3","2"},
        {"0","1","2","2","1","3","2"},
        {"0","2","0","0","1","3","2"},
        {"0","0","0","3","3","2"},
        {"3","3","3","2","2"},
        {"2","2","2"}
    },
    ["4"] = {
        8,
        {"0","0","0","0","1","2"},
        {"0","0","0","1","2"},
        {"0","0","1","2","0","1","2"},
        {"0","1","3","2","1","3","2"},
        {"1","3","2","0","1","3","2"},
        {"3","3","3","3","3","1","1","2"},
        {"2","2","2","2","3","2","2"},
        {"0","0","0","0","2"}
    },
    ["5"] = {
        7,
        {"0","1","1","1","1","2"},
        {"0","1","2","2","2"},
        {"1","1","1","3","3","2"},
        {"3","2","2","2","1","3","2"},
        {"2","0","0","0","3","3","2"},
        {"0","0","0","3","3","2"},
        {"3","3","3","2","2"},
        {"2","2","2"}
    },
    ["6"] = {
        7,
        {"0","0","0","0","1","2"},
        {"0","0","1","1","2"},
        {"0","1","3","2"},
        {"1","3","1","1","3","2"},
        {"3","1","2","2","2","3","2"},
        {"3","1","2","0","1","3","2"},
        {"2","3","3","3","3","2"},
        {"0","2","2","2","2"}
    },
    ["7"] = {
        8,
        {"0","1","1","1","1","1","1","2"},
        {"1","2","2","2","1","3","2"},
        {"2","0","0","1","3","2"},
        {"0","0","0","3","2"},
        {"0","0","1","3","2"},
        {"0","0","3","2"},
        {"0","0","3","2"},
        {"0","0","2"}
    },
    ["8"] = {
        8,
        {"0","0","1","1","1","1","2"},
        {"0","1","3","2","2","2","1","2"},
        {"0","2","1","3","2","0","1","2"},
        {"0","3","1","2","3","3","2"},
        {"3","1","2","0","2","1","3","2"},
        {"3","1","2","0","0","1","3","2"},
        {"2","3","3","3","3","3","2"},
        {"0","2","2","2","2","2","2"}
    },
    ["9"] = {
        7,
        {"0","1","1","1","1","2"},
        {"1","1","2","2","2","3","2"},
        {"1","1","2","0","0","3","2"},
        {"2","1","3","2","3","3","2"},
        {"0","2","2","1","3","2"},
        {"0","0","3","3","2"},
        {"0","3","2","2"},
        {"0","2"}
    },
    ["!"] = {
        3,
        {"3","1","3"},
        {"3","1","3"},
        {"3","3"},
        {"3","3"},
        {"3","2"},
        {"0"},
        {"2","3"},
        {"2","2"}
    },
    [":"] = {
        3,
        {},
        {"0", "3", "1"},
        {"0", "2", "2"},
        {},
        {},
        {"0", "3", "1"},
        {"0", "2", "2"}
    }
}

function gnghud.drawText(screen, text, timer)
    -- Draw hud container
    screen:draw_box(x1, y1, x2, y2, 0, 0xAA000000)

    local xOffset = x1 + 1
    local yOffset = y1 + 1

    -- Draw letters
    for c in text:gmatch(".") do
        xOffset = xOffset + drawLetter(screen, xOffset, yOffset, c, p3)
    end

    -- Draw timer, right-aligned.  Assumes timer is never greater than 2 digits
    if (timer ~= nil and timer > 0) then
        local digit1
        local digit2
        local digit1XOffset
        local digit2XOffset

        if (timer < 10) then
            digit2 = tostring(timer)
        else
            digit1 = tostring(math.floor(timer / 10))
            digit2 = tostring(timer % 10)
        end

        local digit2XOffset = x2 - 3 - pixelMaps[digit2][1]
        drawLetter(screen, digit2XOffset, yOffset, digit2)

        if (timer > 9) then
            local digit1XOffset = digit2XOffset - pixelMaps[digit1][1]
            drawLetter(screen, digit1XOffset, yOffset, digit1)
        end
    end
end

function drawLetter(screen, x, y, character, palette)
    if (character == " ") then return 4 end

    local pixels = pixelMaps[string.upper(character)]

    local p
    if (palette ~= nil) then p = palette
    else p = p1 end

    if not pixels then return 0 end

    local width

    for yo,v in pairs(pixels) do
        if (type(v) == "number") then
            width = v
        else
            local xo = 0
            for xo,c in pairs(v) do
                screen:draw_box(x + xo, y + yo, x + xo + 1, y + yo + 1, 0, p[c])
            end
        end
    end

    return width
end

return exports